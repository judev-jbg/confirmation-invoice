# Script de configuración inicial
# Ejecutar UNA VEZ para configurar el proyecto

$OutputEncoding = [System.Text.Encoding]::UTF8
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8

# MODIFICAR ESTA RUTA
$ProjectPath = "C:\ruta\al\proyecto\confirmation-invoice"

Write-Host "=" * 60
Write-Host "SETUP - Confirmación de Facturas - Toolstock"
Write-Host "=" * 60
Write-Host ""

# Cambiar al directorio del proyecto
Set-Location $ProjectPath

# 1. Verificar Python
Write-Host "[1/6] Verificando Python..." -ForegroundColor Cyan
$pythonVersion = python --version 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  ✓ Python encontrado: $pythonVersion" -ForegroundColor Green
} else {
    Write-Host "  ✗ ERROR: Python no encontrado" -ForegroundColor Red
    Write-Host "  Por favor, instala Python 3.8+ desde https://www.python.org/" -ForegroundColor Yellow
    exit 1
}

# 2. Crear entorno virtual
Write-Host ""
Write-Host "[2/6] Creando entorno virtual..." -ForegroundColor Cyan
if (Test-Path "$ProjectPath\venv") {
    Write-Host "  ! El entorno virtual ya existe, saltando..." -ForegroundColor Yellow
} else {
    python -m venv venv
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  ✓ Entorno virtual creado" -ForegroundColor Green
    } else {
        Write-Host "  ✗ ERROR: No se pudo crear el entorno virtual" -ForegroundColor Red
        exit 1
    }
}

# 3. Instalar dependencias
Write-Host ""
Write-Host "[3/6] Instalando dependencias..." -ForegroundColor Cyan
$pipExe = "$ProjectPath\venv\Scripts\pip.exe"
& $pipExe install --upgrade pip
& $pipExe install -r requirements.txt

if ($LASTEXITCODE -eq 0) {
    Write-Host "  ✓ Dependencias instaladas correctamente" -ForegroundColor Green
} else {
    Write-Host "  ✗ ADVERTENCIA: Algunas dependencias pueden no haberse instalado" -ForegroundColor Yellow
}

# 4. Verificar .env
Write-Host ""
Write-Host "[4/6] Verificando archivo .env..." -ForegroundColor Cyan
if (Test-Path "$ProjectPath\.env") {
    Write-Host "  ✓ Archivo .env encontrado" -ForegroundColor Green

    # Verificar variables críticas
    $envContent = Get-Content "$ProjectPath\.env" -Raw
    $criticalVars = @(
        "PRESTASHOP_API_USERNAME",
        "ORDERS_SENDER_EMAIL",
        "ORDERS_SENDER_PASSWORD",
        "GOOGLE_SERVICE_ACCOUNT_FILE",
        "GOOGLE_SHEET_ID"
    )

    $missingVars = @()
    foreach ($var in $criticalVars) {
        if ($envContent -notmatch "$var=.+") {
            $missingVars += $var
        }
    }

    if ($missingVars.Count -gt 0) {
        Write-Host "  ⚠ ADVERTENCIA: Variables faltantes o vacías en .env:" -ForegroundColor Yellow
        foreach ($var in $missingVars) {
            Write-Host "    - $var" -ForegroundColor Yellow
        }
    } else {
        Write-Host "  ✓ Todas las variables críticas están configuradas" -ForegroundColor Green
    }

} else {
    Write-Host "  ✗ ADVERTENCIA: .env no encontrado" -ForegroundColor Yellow
    Write-Host "  Se usará .env.example como referencia..." -ForegroundColor Yellow

    if (Test-Path "$ProjectPath\.env.example") {
        Copy-Item "$ProjectPath\.env.example" "$ProjectPath\.env"
        Write-Host "  ✓ Archivo .env creado desde .env.example" -ForegroundColor Green
        Write-Host "  ⚠ IMPORTANTE: Edita .env y completa las variables faltantes" -ForegroundColor Yellow
    }
}

# 5. Verificar credentials-service.json
Write-Host ""
Write-Host "[5/6] Verificando credenciales de Google..." -ForegroundColor Cyan
if (Test-Path "$ProjectPath\credentials-service.json") {
    Write-Host "  ✓ credentials-service.json encontrado" -ForegroundColor Green

    # Verificar que es un JSON válido
    try {
        $creds = Get-Content "$ProjectPath\credentials-service.json" -Raw | ConvertFrom-Json
        if ($creds.type -eq "service_account") {
            Write-Host "  ✓ Archivo de Service Account válido" -ForegroundColor Green
            Write-Host "    Email: $($creds.client_email)" -ForegroundColor Gray
        } else {
            Write-Host "  ⚠ ADVERTENCIA: No parece ser un archivo de Service Account" -ForegroundColor Yellow
        }
    } catch {
        Write-Host "  ✗ ERROR: credentials-service.json no es un JSON válido" -ForegroundColor Red
    }
} else {
    Write-Host "  ✗ ADVERTENCIA: credentials-service.json no encontrado" -ForegroundColor Yellow
    Write-Host "    Copia el archivo de credenciales de Google a la raíz del proyecto" -ForegroundColor Yellow
    Write-Host "    Nombre: credentials-service.json" -ForegroundColor Yellow
}

# 6. Crear estructura de directorios
Write-Host ""
Write-Host "[6/6] Creando estructura de directorios..." -ForegroundColor Cyan

$directories = @("logs")

foreach ($dir in $directories) {
    $dirPath = "$ProjectPath\$dir"
    if (-not (Test-Path $dirPath)) {
        New-Item -ItemType Directory -Path $dirPath -Force | Out-Null
        Write-Host "  ✓ Creado: $dir" -ForegroundColor Green
    } else {
        Write-Host "  ✓ Ya existe: $dir" -ForegroundColor Gray
    }
}

# Resumen final
Write-Host ""
Write-Host "=" * 60
Write-Host "SETUP COMPLETADO" -ForegroundColor Green
Write-Host "=" * 60
Write-Host ""
Write-Host "Próximos pasos:" -ForegroundColor Cyan
Write-Host "  1. Copia run.ps1.example a run.ps1 y modifica la ruta del proyecto"
Write-Host "  2. Edita el archivo .env y completa todas las variables"
Write-Host "  3. Asegúrate de tener credentials-service.json en la raíz"
Write-Host "  4. Verifica que la carpeta de Drive esté compartida con la Service Account"
Write-Host "  5. Ejecuta en modo desarrollo primero:"
Write-Host "     .\run.ps1"
Write-Host "  6. Revisa los logs en logs/confirmation_invoice.log"
Write-Host ""
Write-Host "Para ejecutar manualmente: .\run.ps1" -ForegroundColor Green
Write-Host ""
